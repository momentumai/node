var Promise = require('bluebird'),
    uuid = require('@lib/utils/uuid'),
    ua = require('universal-analytics'),
    config = require('@config');

function getVisitor () {
    if (config.frontend.ga.debug) {
        return ua(config.frontend.ga.id).debug();
    }
    return ua(config.frontend.ga.id);
}

module.exports.sendPromotion = function (
    teamId,
    budget,
    offset,
    currency,
    autoStart
) {
    return new Promise(function (resolve) {
        var visitor = getVisitor(),
            trParams = {
                'ti': String(uuid.next()),
                'ta': String(teamId),
                'tr': Number(budget) / (Number(offset) || 100),
                'cu': currency || 'USD'
            },
            itemParams = {
                'iv': autoStart ? 'auto_start' : 'manual_start',
                'in': 'promotion'
            };

        visitor.transaction(trParams)
            .item(itemParams)
            .send(function () {
                resolve();
            });
    });
};
