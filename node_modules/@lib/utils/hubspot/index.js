var Promise = require('bluebird'),
    request = require('request'),
    hapikey = '9f00edf7-2cea-417a-8507-8c9c300b3cc7',
    endpoint = 'http://api.hubapi.com/contacts/v1/',
    hubspot = {};

function updateContact (email) {
    return new Promise(function (resolve) {
        var options = {
            'uri': [
                endpoint,
                'contact/createOrUpdate/email/',
                email,
                '/?hapikey=',
                hapikey
            ].join(''),
            'method': 'POST',
            'json': {
                'properties': [{
                    'property': 'email',
                    'value': email
                }]
            }
        };

        request.post(options, function (error, response, contact) {
            return resolve(contact['vid']);
        });
    });
}

hubspot.insertToList = function (email, listId) {
    return new Promise(function (resolve) {
        return updateContact(email).then(function (vid) {
            var options = {
                'uri': [
                    endpoint,
                    'lists/',
                    listId,
                    '/add/?hapikey=',
                    hapikey
                ].join(''),
                'method': 'POST',
                'json': {
                    'vids': [vid]
                }
            };

            request.post(options, function () {
                return resolve();
            });
        }).catch(function () {
            console.error('hubspot error on insertToList');
            resolve();
        });
    });
};

hubspot.moveToList = function (email, fromListId, toListId) {
    return new Promise(function (resolve) {
        return updateContact(email).then(function (vid) {
            var options = {
                'uri': [
                    endpoint,
                    'lists/',
                    fromListId,
                    '/remove/?hapikey=',
                    hapikey
                ].join(''),
                'method': 'POST',
                'json': {
                    'vids': [vid]
                }
            };

            request.post(options, function () {
                return hubspot.insertToList(email, toListId).then(function () {
                    resolve();
                });
            });
        }).catch(function () {
            console.error('hubspot error on moveToList');
            resolve();
        });
    });
};

module.exports = hubspot;
