var path = require('path'),
    Promise = require('bluebird'),
    resources = require('@lib/resources'),
    db = require('@lib/resources/db'),
    sqlUtils = require('@lib/utils/sql'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    handler = require('./handler');

function handleRequest (event, context, logger) {
    var local = {};

    return resources.get().then(function (resources) {
        local.r = resources;
        return db.q(q['teams'], {}, local.r.pool);
    }).then(function (rows) {
        var promises = [];

        rows.forEach(function (row) {
            promises.push(handler({
                'team_id': row.team_id,
                'user_id': row.user_id,
                'access_token': row.access_token,
                'type': row.type,
                'asset_id': row.asset_id
            }, local));
        });
        return Promise.all(promises);
    }).catch(function (err) {
        local.err = err;
        logger.error(err);
    }).finally(function () {
        return resources.dispose(local.r).then(function () {
            if (local.err) {
                return context.fail(local.err);
            }
            return context.succeed();
        });
    });
}

module.exports = handleRequest;
