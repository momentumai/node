var path = require('path'),
    sqlUtils = require('@lib/utils/sql'),
    db = require('@lib/resources/db'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    Promise = require('bluebird'),
    toplist = require('@lib/model/toplist');

module.exports.handler = function (event, context) {
    var params = {
        'team_id': event.team_id,
        'cats': [event.cat1, event.cat2, event.cat3],
        'to': event.timestamp
    };

    return Promise.join(
        toplist.get(
            params.team_id,
            params.cats,
            params.to
        ),
        db.q(
            q['promoted'],
            params,
            context.pool
        ),
        function (toplist, promoted) {
            return promoted.map(function (act) {
                var content = toplist.filter(function (cont) {
                    return cont.contentId === act.content_id;
                })[0] || {
                    'momentum': 0
                };

                return {
                    'id': act.content_id,
                    'momentum': content.momentum * 100,
                    'promotion_id': act.promotion_id,
                    'campaign_id': act.campaign_id
                };
            });
        }
    );
};
