var path = require('path'),
    sqlUtils = require('@lib/utils/sql'),
    db = require('@lib/resources/db'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    Promise = require('bluebird'),
    toplist = require('@lib/model/toplist');

module.exports.handler = function (event, context) {
    var params = {
        'team_id': event.team_id,
        'to': event.timestamp,
        'cats': [event.cat1, event.cat2, event.cat3]
    };

    return Promise.join(
        toplist.get(
            event.team_id,
            [event.cat1, event.cat2, event.cat3],
            event.timestamp
        ),
        db.q(
            q['alerted'],
            params,
            context.pool
        ),
        function (tl, alerted) {
            return event.rules.reduce(function (prev, rule) {
                prev[rule.id] = tl.filter(function (act) {
                    return !alerted.filter(function (act2) {
                        return act.contentId === act2.content_id;
                    })[0];
                }).map(function (act) {
                    return {
                        'id': act.contentId,
                        'momentum': act.momentum * 100,
                        'promotion_id': null,
                        'campaign_id': null
                    };
                });

                return prev;
            }, {});
        }
    );
};

