var path = require('path'),
    sqlUtils = require('@lib/utils/sql'),
    db = require('@lib/resources/db'),
    time = require('@lib/utils/time'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    Promise = require('bluebird');

module.exports.handler = function (event, context) {
    return Promise.all(
        event.facts.reduce(function (prev, act) {
            var params = {
                'to': event.env.timestamp,
                'content_id': act.id,
                'team_id': event.env.team_id,
                'cat1': event.env.cat1,
                'cat2': event.env.cat2,
                'cat3': event.env.cat3,
                'expire': time.nextMonthEnd(event.env.timestamp)
            };

            prev.push(db.q(q['alert_add'], params, context.pool));
            return prev;
        }, [])
    );
};
