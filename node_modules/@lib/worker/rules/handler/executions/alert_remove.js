var path = require('path'),
    sqlUtils = require('@lib/utils/sql'),
    db = require('@lib/resources/db'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    notifModel = require('@lib/model/notif'),
    Promise = require('bluebird');

module.exports.handler = function (event, context) {
    return Promise.all(
        event.facts.reduce(function (prev, act) {
            var params = {
                'until': event.env.timestamp,
                'content_id': act.id,
                'team_id': event.env.team_id,
                'cats': [event.env.cat1, event.env.cat2, event.env.cat3]
            };

            prev.push(db.q(q['alert_finish'], params, context.pool));
            prev.push(notifModel.removeForTeam({
                'cat1': event.env.cat1,
                'cat2': event.env.cat2,
                'cat3': event.env.cat3,
                'team_id': event.env.team_id,
                'content_id': act.id
            }, context.pool));
            return prev;
        }, [])
    );
};
