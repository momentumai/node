var path = require('path'),
    sqlUtils = require('@lib/utils/sql'),
    db = require('@lib/resources/db'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    Promise = require('bluebird');

module.exports.handler = function (event, context) {
    return Promise.all(
        event.facts.reduce(function (prev, act) {
            var params = {
                'until': event.env.timestamp,
                'content_id': act.id,
                'team_id': event.env.team_id,
                'cats': [event.env.cat1, event.env.cat2, event.env.cat3],
                'rule_id': act.parent
            };

            prev.push(db.q(q['promote_finish'], params, context.pool));
            return prev;
        }, [])
    );
};
