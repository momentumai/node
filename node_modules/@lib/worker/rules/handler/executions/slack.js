var config = require('@config'),
    Promise = require('bluebird'),
    handlebars = require('handlebars'),
    request = require('request');

function sendSlack (env, fact) {
    var template = '@channel\n\n' +
        'team: {{name}}\n\n' +
        'momentum: {{momentum}}\n\n' +
        '<{{base}}/#/router/{{teamId}}?redirect={{redirect}}>\n\n' +
        '--------------------',
        url = '#/dashboard/main/content/' + fact.id,
        options = {
            'uri': config.notification.slack,
            'form': null
        };

    if (env.cat1 !== 'NONE' ||
        env.cat2 !== 'NONE' ||
        env.cat3 !== 'NONE') {
        return Promise.resolve();
    }

    options.form = JSON.stringify({
        'text': handlebars.compile(
            template,
            {'noEscape': true}
        )({
            'name': env.team_name,
            'base': config.frontend.docBase,
            'teamId': env.team_id,
            'momentum': Math.round(fact.momentum),
            'redirect': encodeURIComponent(
                url
            )
        })
    });

    return new Promise(function (resolve) {
        request.post(options, function () {
            resolve();
        });
    });
}

module.exports.handler = function (event) {
    return Promise.all(
        event.facts.reduce(function (prev, act) {
            prev.push(sendSlack(
                event.env,
                act
            ));
            return prev;
        }, [])
    );
};
