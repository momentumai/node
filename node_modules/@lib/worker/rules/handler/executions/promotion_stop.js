var promotionModel = require('@lib/model/promotion'),
    Promise = require('bluebird');

function parsePromotionId (id) {
    return id && id !== '0' && id || null;
}

function stopPromotion (env, fact, pool) {
    var adsetId = parsePromotionId(fact.promotion_id);

    if (!adsetId || !fact.campaign_id) {
        return Promise.resolve();
    }

    return promotionModel.stopPromotion(
        env.team_id,
        adsetId,
        fact.campaign_id,
        env.timestamp,
        pool
    );
}

module.exports.handler = function (event, context) {
    return Promise.all(
        event.facts.reduce(function (prev, act) {
            prev.push(stopPromotion(event.env, act, context.pool));
            return prev;
        }, [])
    );
};
