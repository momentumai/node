var config = require('@config'),
    path = require('path'),
    gcloud = require('gcloud'),
    Promise = require('bluebird'),
    uuid = require('uuid'),
    ds = {};

function getDataStore (namespace) {
    var cfg = {
        'projectId': config.google.projectId,
        'credentials': config.google.credentials
    };

    if (namespace) {
        cfg.namespace = String(namespace);
    }

    return gcloud.datastore(cfg);
}

ds.init = function (namespace) {
    return Promise.resolve().then(function () {
        return getDataStore(namespace);
    }).catch(function () {
        return ds.init(namespace);
    });
};

ds.get = function (kind, keys, namespace) {
    var datastore = getDataStore(namespace),
        single = false;

    if (keys && !Array.isArray(keys)) {
        keys = [keys];
        single = true;
    }

    if (!keys || !keys.length) {
        return Promise.resolve([]);
    }

    return (new Promise(function (resolve, reject) {
        datastore.get(keys.reduce(function (prev, act) {
            prev.push(datastore.key([String(kind), String(act)]));
            return prev;
        }, []), function (err, resp) {
            if (err) {
                return reject(err);
            }

            if (single) {
                return resolve(resp && resp[0] && resp[0].data || null);
            }
            return resolve(resp || []);
        });
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.get(kind, keys, namespace);
        }

        throw err;
    });
};

ds.set = function (kind, data, namespace) {
    var datastore = getDataStore(namespace),
        model = require(path.join('@lib', 'model', 'datastore', kind));

    if (data && !Array.isArray(data)) {
        data = [data];
    }

    if (!data || !data.length) {
        return Promise.resolve([]);
    }

    return (new Promise(function (resolve, reject) {
        datastore.upsert(data.reduce(function (prev, act) {
            prev.push({
                'key': datastore.key(
                    [String(kind), String(act.key) || uuid.v4()]
                ),
                'data': Object.keys(act.data).reduce(function (prev, key) {
                    prev.push({
                        'name': key,
                        'value': act.data[key],
                        'excludeFromIndexes':
                            model.excludeIndexes.indexOf(key) !== -1
                    });
                    return prev;
                }, [])
            });
            return prev;
        }, []), function (err) {
            if (err) {
                console.error(err);
                return reject(err);
            }
            return resolve();
        });
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.set(kind, data, namespace);
        }

        throw err;
    });
};

ds.delete = function (kind, keys, namespace) {
    var datastore = getDataStore(namespace);

    if (keys && !Array.isArray(keys)) {
        keys = [keys];
    }

    if (!keys || !keys.length) {
        return Promise.resolve([]);
    }

    return (new Promise(function (resolve, reject) {
        datastore.delete(keys.map(function (key) {
            return datastore.key([String(kind), String(key)]);
        }), function (err) {
            if (err) {
                console.error(err);
                return reject(err);
            }
            return resolve();
        });
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.delete(kind, keys, namespace);
        }

        throw err;
    });
};

ds.query = function (kind, queryFunction, namespace) {
    var datastore = getDataStore(namespace);

    return (new Promise(function (resolve, reject) {
        datastore.runQuery(
            queryFunction(datastore.createQuery(kind)),
            function (err, resp) {
                if (err) {
                    return reject(err);
                }

                return resolve(resp || null);
            }
        );
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.runQuery(kind, queryFunction, namespace);
        }

        throw err;
    });
};

ds.extend = function (kind, keys, updateFunction, namespace) {
    var datastore = getDataStore(namespace),
        transaction = datastore.transaction(),
        model = require(path.join('@lib', 'model', 'datastore', kind));

    if (keys && !Array.isArray(keys)) {
        keys = [keys];
    }

    if (!keys || !keys.length) {
        return Promise.resolve([]);
    }
    return new Promise(function (resolve, reject) {
        transaction.run(function (err) {
            if (err) {
                return reject(err);
            }
            transaction.get(keys.reduce(function (prev, act) {
                prev.push(datastore.key([String(kind), String(act)]));
                return prev;
            }, []), function (err, resp) {
                if (err) {
                    return transaction.rollback(function (getError) {
                        return reject(getError || err);
                    });
                }

                resp = resp.map(function (item) {
                    var data = updateFunction(item.data, item.key);

                    return {
                        'key': item.key,
                        'data': Object.keys(data).reduce(function (prev, key) {
                            prev.push({
                                'name': key,
                                'value': data[key],
                                'excludeFromIndexes':
                                    model.excludeIndexes.indexOf(key) !== -1
                            });
                            return prev;
                        }, [])
                    };
                });

                transaction.save(resp);
                transaction.commit(function (err) {
                    if (err) {
                        return reject(err);
                    }
                    resolve();
                });
            });
        });
    });
};

module.exports = ds;
