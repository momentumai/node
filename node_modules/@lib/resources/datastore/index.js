var config = require('@config'),
    gcloud = require('gcloud'),
    Promise = require('bluebird'),
    ds = {};

function getDataStore (namespace) {
    var cfg = {
        'projectId': config.google.projectId,
        'credentials': config.google.credentials
    };

    if (namespace) {
        cfg.namespace = String(namespace);
    }

    return gcloud.datastore(cfg);
}

ds.init = function (namespace) {
    return Promise.resolve().then(function () {
        return getDataStore(namespace);
    }).catch(function () {
        return ds.init(namespace);
    });
};

ds.get = function (namespace, kind, key) {
    var datastore = getDataStore(namespace);

    return (new Promise(function (resolve, reject) {
        datastore.get(
            datastore.key([String(kind), String(key)]
        ), function (err, resp) {
            if (err) {
                return reject(err);
            }

            return resolve(resp && resp.data || null);
        });
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.get(namespace, kind, key);
        }

        throw err;
    });
};

ds.getMulti = function (namespace, kind, keys) {
    var datastore = getDataStore(namespace);

    if (!keys.length) {
        return Promise.resolve([]);
    }

    return (new Promise(function (resolve, reject) {
        var dsKeys = [];

        keys.forEach(function (key) {
            dsKeys.push(datastore.key([String(kind), String(key)]));
        });
        datastore.get(dsKeys, function (err, resp) {
            if (err) {
                return reject(err);
            }

            return resolve(resp || []);
        });
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.getMulti(namespace, kind, keys);
        }

        throw err;
    });
};

ds.set = function (namespace, kind, key, item, excludeIndexes) {
    var datastore = getDataStore(namespace),
        data = [];

    excludeIndexes = excludeIndexes || [];
    Object.keys(item).forEach(function (name) {
        data.push({
            'name': name,
            'value': item[name],
            'excludeFromIndexes': (excludeIndexes.indexOf(name) !== -1)
        })
    });

    return (new Promise(function (resolve, reject) {
        datastore.save({
            'key': datastore.key([String(kind), String(key)]),
            'data': data
        }, function (err) {
            if (err) {
                return reject(err);
            }
            return resolve();
        });
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.set(namespace, kind, key, data);
        }

        throw err;
    });
};

ds.setMulti = function (namespace, kind, data) {
    var datastore = getDataStore(namespace);

    if (!data.length) {
        return Promise.resolve();
    }

    return (new Promise(function (resolve, reject) {
        var dsData = [];

        data.forEach(function (item) {
            dsData.push({
                'key': datastore.key([String(kind), String(item.key)]),
                'data': item.data
            });
        });
        datastore.upsert(dsData, function (err) {
            if (err) {
                console.error(err);
                return reject(err);
            }
            return resolve();
        });
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.setMulti(namespace, kind, data);
        }

        throw err;
    });
};

ds.runQuery = function (query, datastore) {
    return (new Promise(function (resolve, reject) {
        datastore.runQuery(query, function (err, resp) {
            if (err) {
                return reject(err);
            }

            return resolve(resp || null);
        });
    })).catch(function (err) {
        if (err.code === 503) {
            return ds.runQuery(query, datastore);
        }

        throw err;
    });
};

module.exports = ds;
