var ds = require('@lib/resources/datastore'),
    Promise = require('bluebird'),
    blacklist = {};

blacklist.update = function (teamId, url, blacklist) {
    var content = ds.get(teamId, 'Content', url).then(function (data) {
            if (!data) {
                return {};
            }

            if (data.is_blacklisted !== blacklist) {
                data.is_blacklisted = blacklist;
                return ds.set(teamId, 'Content', url, data).then(function () {
                    return {};
                });
            }

            return {};
        }),
        bl = ds.get(null, 'BlacklistedContent', teamId);

    bl.then(function (data) {
        var blacklisted;

        if (!data || !Object.keys(data).length) {
            data = {
                'contents': []
            };
        }

        if (!data.contents.length) {
            if (blacklist) {
                data.contents.push(url);
            }
        } else {
            blacklisted = data.contents.filter(function (act) {
                return act === url;
            }).length;

            if (blacklist && blacklisted) {
                return;
            }

            if (!blacklist && !blacklisted) {
                return;
            }

            if (blacklist && !blacklisted) {
                data.contents.push(url);
            } else {
                data.contents = data.contents.filter(function (act) {
                    return act !== url;
                });
            }
        }

        return ds.set(null, 'BlacklistedContent', teamId, data);
    });

    return Promise.all([
        content,
        bl
    ]).then(function () {
        return {};
    });
};

module.exports = blacklist;
