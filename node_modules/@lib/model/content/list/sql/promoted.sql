SELECT  
    content_id
FROM promotion
WHERE until = 0 AND
    team_id = {{team_id}} AND
    content_id = '{{content_id}}' AND
{{#each cats}}
    cat{{inc @index}} = '{{.}}' AND
{{/each}}
    {{to}} < expire

UNION

SELECT
    alert.content_id
FROM alert
INNER JOIN campaign
ON alert.campaign_id = campaign.id
WHERE alert.until = 0 AND
    alert.team_id = {{team_id}} AND
    alert.content_id = '{{content_id}}' AND
{{#each cats}}
    alert.cat{{inc @index}} = '{{.}}' AND
{{/each}}
    {{to}} < alert.expire AND
    {{to}} < campaign.end_time

UNION

SELECT DISTINCT campaign.content_id
FROM campaign
LEFT JOIN alert
ON alert.campaign_id = campaign.id
WHERE alert.campaign_id IS NULL AND
    campaign.content_id = '{{content_id}}' AND
{{#each campaign_cats}}
    {{#if .}}
        campaign.cat{{inc @index}} = '{{.}}' AND
    {{/if}}
{{/each}}
    campaign.team_id = {{team_id}} AND
    campaign.finished = 1 AND
    {{to}} < campaign.end_time;
