var ds = require('@lib/resources/datastore'),
    sources = {};

function calcHistory (data) {
    var sources = {},
        sum = {
            'seed': 0,
            'viral': 0
        };

    Object.keys(data).forEach(function (key) {
        sources[key] = {
            'seed': parseInt(data[key].shares || 0),
            'viral': 0
        };
        sum.seed += sources[key].seed;
    });

    return {
        'sources': sources,
        'seed': sum.seed,
        'viral': sum.viral
    };
}

function getType (type) {
    if (type === 'paid') {
        return 3;
    }
    if (type === 'team') {
        return 2;
    }
    return 1;
}

sources.history = function (teamId, contentId) {
    var id = [teamId, contentId].join('||'),
        types = ['organic', 'team', 'paid'];

    return ds.get(null, 'HistoryReferrerModel', id).then(function (rows) {
        var data = {},
            resp = {};

        try {
            data = JSON.parse(rows.value);
        } catch (ignore) {
            //ignore
        }

        types.forEach(function (type) {
            var row = data[getType(type)] && data[getType(type)].referrer;

            resp[type] = calcHistory(row || {});
        });
        return resp;
    });
};
module.exports = sources;
