SELECT
    content.id,
    content.url,
    SUM(
        log2(generation + 1) * share * 100
    ) / (
        SELECT SUM(max_score) FROM
        (
            SELECT MAX(sum_score) AS max_score
            FROM (
                SELECT
                    timestamp,
                    generation,
                    SUM(
                      log2(generation + 1) * share * 100
                    ) AS sum_score
                FROM share
                WHERE timestamp BETWEEN {{from}} AND {{to}} AND
                {{#each cats}}
                    cat{{inc @index}} = {{.}} AND
                {{/each}}
                    team_id = {{team_id}}
                GROUP BY share.content_id, share.timestamp, share.generation
            ) AS sum_score
            GROUP BY timestamp, generation
        ) AS max_score
    ) AS momentum,
    IF((
        SELECT count(alert.id) FROM alert
        WHERE alert.content_id = content.id AND
        {{#each alertCats}}
            alert.cat{{inc @index}} = {{.}} AND
        {{/each}}
            alert.until = 0 AND
            alert.team_id = {{team_id}}
   ) > 0, 1, 0) as recommended
FROM share
JOIN content
ON content.id = share.content_id
WHERE timestamp BETWEEN {{from}} AND {{to}} AND
{{#each cats}}
    share.cat{{inc @index}} = {{.}} AND
{{/each}}
    share.team_id = {{team_id}}
GROUP BY content_id
HAVING recommended = 1
ORDER BY momentum DESC
LIMIT {{limit}};
