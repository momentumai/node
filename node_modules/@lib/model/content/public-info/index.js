var memcached = require('@lib/resources/memcached'),
    Facebook = require('@lib/utils/facebook'),
    Promise = require('bluebird'),
    extend = require('extend'),
    request = require('request'),
    cheerio = require('cheerio'),
    info = {};

function getContentFromWeb (url) {
    if (!url) {
        return Promise.resolve('');
    }

    url = 'http://' + url;

    return new Promise(function (resolve) {
        request.get({
            'url': url,
            'timeout': 5000
        }, function (err, ignore, body) {
            if (err) {
                console.error(err);
                resolve('');
            }
            resolve(body);
        });
    });
}

function getOgDataFromWeb (url) {
    return getContentFromWeb(url).then(function (resp) {
        var c = {},
            $;

        $ = cheerio.load(resp);

        c.site_name = $('meta[property="og:site_name"]').attr('content');
        c.title = $('meta[property="og:title"]').attr('content');
        c.description = $('meta[property="og:description"]').attr('content');
        c.image = $('meta[property="og:image"]').attr('content');

        return c;
    });
}

function getOgAndSetMemcache (teamId, url, memcacheResource) {
    return Promise.join(
        Facebook.getOgData(url),
        getOgDataFromWeb(url)
    ).then(function (resp) {
        var content = extend({}, resp[0], resp[1]);

        return memcached.set({
            'team_id': teamId,
            'type': 'content-public-info',
            'key': url,
            'value': content
        }, memcacheResource).then(function () {
            return content;
        });
    });
}

info.get = function (teamId, url) {
    var mResource;

    return memcached.init().then(function (res) {
        mResource = res;

        return memcached.get({
            'team_id': teamId,
            'type': 'content-public-info',
            'key': url
        }, mResource);
    }).then(function (content) {
        if (!content.title) {
            return getOgAndSetMemcache(teamId, url, mResource);
        }

        return content;
    });
};

module.exports = info;
