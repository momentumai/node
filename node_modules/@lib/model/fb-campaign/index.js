var path = require('path'),
    db = require('@lib/resources/db'),
    sqlUtils = require('@lib/utils/sql'),
    catUtils = require('@lib/utils/category'),
    Facebook = require('@lib/utils/facebook'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    fbCampaign = {};

function validateCampaign (campaign, fb) {
    var url = campaign,
        params = {
            'status': 'ACTIVE'
        };

    return Facebook.post(url, params, fb.token).then(function (resp) {
        if (resp && resp.success) {
            return campaign;
        }

        return '';
    }).catch(function () {
        return '';
    });
}

function getCampaignName (cats) {
    var name = ['Momentum'];

    cats.forEach(function (cat) {
        if (cat !== 'NONE') {
            name.push(decodeURIComponent(cat));
        }
    });

    if (name.length === 1) {
        name.push('Global');
    }

    return name.join(' - ');
}

function createFbCampaign (name, adaccount, fb) {
    var url = adaccount + '/campaigns',
        params = {
            'name': name,
            'objective': 'LINK_CLICKS',
            'status': 'ACTIVE'
        };

    return Facebook.post(url, params, fb.token).then(function (resp) {
        return resp.id;
    });
}

function add (teamId, cats, adaccount, fb, pool) {
    var campaignId,
        campaignName;

    catUtils.extend(cats);

    campaignName = getCampaignName(cats);

    return createFbCampaign(
        campaignName,
        adaccount,
        fb
    ).then(function (resp) {
        campaignId = resp;
        return db.q(q['fb_campaign_insert'], {
            'team_id': teamId,
            'cat1': cats[0],
            'cat2': cats[1],
            'cat3': cats[2],
            'adaccount': adaccount,
            'campaign_id': campaignId
        }, pool);
    }).then(function () {
        return campaignId;
    });
}

fbCampaign.addGet = function (teamId, cats, adaccount, fb, pool) {
    catUtils.extend(cats);

    return fbCampaign.get(
        teamId,
        cats,
        adaccount,
        fb,
        pool
    ).then(function (campaignId) {
        if (!campaignId) {
            return add(teamId, cats, adaccount, fb, pool);
        }
        return campaignId;
    });
};

fbCampaign.get = function (teamId, cats, adaccount, fb, pool) {
    catUtils.extend(cats);

    return db.q(q['fb_campaign_get'], {
        'team_id': teamId,
        'adaccount': adaccount,
        'cats': cats
    }, pool).then(function (rows) {
        return rows[0] && rows[0].campaign_id || '';
    }).then(function (campaign) {
        return validateCampaign(campaign, fb);
    });
};

module.exports = fbCampaign;
