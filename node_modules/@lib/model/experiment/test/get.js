var ds = require('@lib/resources/ds'),
    Promise = require('bluebird'),
    fbAdsetModel = require('@lib/model/fb/adset');

module.exports = function (key, token) {
    var test;

    return ds.get('ExperimentTest', key.name, key.namespace)
    .then(function (resp) {
        test = resp;
        return Promise.all([
            fbAdsetModel.getDetails(test.data.adset, token),
            ds.get('HistoryCampaignModel',
                [key.namespace, key.name].join('||'))]);
    }).then(function (resp) {
        var dsResp = resp[1],
            fbResp = resp[0],
            clicks = 0;

        if (dsResp && dsResp.data && dsResp.data.value) {
            try {
                clicks = JSON.parse(dsResp.data.value).share || 0;
            } catch (ignore) {
                clicks = 0;
            }
        }
        return {
            'id': test.key.name,
            'experiment_id': test.data.experiment_id,
            'adaccount': fbResp.adaccount,
            'page': test.data.page,
            'audience_id': test.data.audience_id,
            'name': test.data.name_text,
            'active': test.data.active,
            'end_time': test.data.end_time,
            'start_time': test.data.created_at,
            'click': clicks,
            'budget': fbResp.budget,
            'spend': fbResp.spend,
            'fb_actions': fbResp.fb_actions,
            'has_permission': fbResp.has_permission
        };
    });
};
