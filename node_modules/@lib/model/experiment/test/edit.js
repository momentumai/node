var ds = require('@lib/resources/ds'),
    Promise = require('bluebird'),
    extend = require('extend'),
    fbAdsetModel = require('@lib/model/fb/adset'),
    fbAdModel = require('@lib/model/fb/ad');

function parseParams (p) {
    var params = {};

    params.team_id = p.team_id || 0;
    params.id = p.id;
    params.data = p.data || {};

    return params;
}

function updateFbAssets (data, item, token) {
    var promises = [];

    if (Object.keys(data.adset).length) {
        promises.push(fbAdsetModel.update(item.data.adset, data.adset, token));
    }
    if (Object.keys(data.ad).length) {
        promises.push(fbAdModel.update(item.data.ad, data.ad, token));
    }

    return Promise.all(promises);
}

function update (params, item, token) {
    var data = {
        'adset': {},
        'ad': {}
    };

    if (typeof params.data.active !== 'undefined') {
        item.data.active = Boolean(params.data.active);
        data.adset.active = item.data.active;
    }
    if (typeof params.data.name_text !== 'undefined') {
        item.data.name_text = String(params.data.name_text);
        data.adset.name_text = item.data.name_text;
        data.ad.name_text = item.data.name_text;
    }
    if (typeof params.data.end_time !== 'undefined') {
        item.data.end_time = new Date(params.data.end_time * 1000);
        data.adset.end_time = Number(params.data.end_time);
    }
    if (typeof params.data.budget !== 'undefined') {
        item.data.budget = Number(params.data.budget);
        data.adset.budget = item.data.budget;
        data.adset.budget_type = 'lifetime_budget';
    }

    return updateFbAssets(data, item, token).then(function () {
        return item;
    });
}

module.exports = function (params, token) {
    params = parseParams(params);

    return ds.get('ExperimentTest', params.id, params.team_id)
    .then(function (item) {
        return update(params, item, token);
    }).then(function (item) {
        return ds.extend('ExperimentTest', item.key.name, function (data) {
            return extend({}, data, item.data);
        }, params.team_id);
    }).then(function () {
        return 'successful';
    });
};
