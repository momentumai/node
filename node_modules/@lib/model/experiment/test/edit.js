var ds = require('@lib/resources/ds'),
    Promise = require('bluebird'),
    extend = require('extend'),
    fbAdsetModel = require('@lib/model/fb/adset');

function parseParams (p) {
    var params = {};

    params.team_id = p.team_id || 0;
    params.id = p.id;
    params.data = p.data || {};

    return params;
}

function updateFbAssets (data, item, token) {
    var promises = [];

    if (data.adset) {
        promises.push(fbAdsetModel.update(item.data.adset, data.adset, token));
    }

    return Promise.all(promises);
}

function update (params, item, token) {
    var data = {};

    if (typeof params.data.active !== 'undefined') {
        item.data.active = Boolean(params.data.active);
        data.adset = data.adset || {};
        data.adset.active = item.data.active;
    }

    return updateFbAssets(data, item, token).then(function () {
        return item;
    });
}

module.exports = function (params, token) {
    params = parseParams(params);

    return ds.get('ExperimentTest', params.id, params.team_id)
    .then(function (item) {
        return update(params, item, token);
    }).then(function (item) {
        return ds.extend('ExperimentTest', item.key.name, function (data) {
            return extend({}, data, item.data);
        }, params.team_id);
    }).then(function () {
        return 'successful';
    });
};
