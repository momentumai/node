var ds = require('@lib/resources/ds'),
    listFormat = require('@lib/model/experiment/listFormat');

function parseParams (p) {
    var params = {};

    params.team_id = p.team_id || 0;
    params.content_id = p.content_id;

    return params;
}

module.exports = function (params, token) {
    params = parseParams(params);

    return ds.get(
        'Experiment',
        [params.content_id],
        params.team_id
    ).then(function (items) {
        return listFormat(params, items, token);
    }).then(function (result) {
        return result && result[0] && result[0].tests || [];
    }).then(function (tests) {
        return tests.reduce(function (best, act) {
            if (Number.isNaN(Number(act.cpa_unformated)) ||
                Number(act.cpa_unformated) < (best.cpa_unformated || 0)) {
                return best;
            }
            return act;
        }, {});
    });
};
