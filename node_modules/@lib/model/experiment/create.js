var Promise = require('bluebird'),
    ds = require('@lib/resources/ds'),
    contentInfo = require('@lib/model/content/info'),
    audience = require('@lib/model/audience'),
    fbCampaign = require('@lib/model/fb/campaign'),
    fbAdset = require('@lib/model/fb/adset');

function parseParams (p) {
    var params = {};

    params.team_id = p.team_id || 0;

    params.name_text = p.name_text || '';
    params.audience_id = p.audience_id || '';
    params.adaccount = p.adaccount || '';
    params.budget_type = p.budget_type || '';
    params.budget = Number(p.budget) || 0;
    params.end_time = Number(p.end_time) || 0;
    params.content_id = p.content_id || '';

    return params;
}

module.exports = function (params, token) {
    params = parseParams(params);

    return Promise.join(
        audience.get(params.team_id, params.audience_id),
        contentInfo.get(params.team_id, params.content_id),
    function (audience, contentInfo) {
        params.audience = audience;
        params.contentInfo = contentInfo;

        return fbCampaign.addGet({
            'team_id': params.team_id,
            'cats': params.contentInfo.cats,
            'adaccount': params.adaccount,
            'type': 'experiment'
        }, token);
    }).then(function (campaign) {
        params.campaign = campaign;

        return fbAdset.add(params.campaign, {
            'adaccount': params.adaccount,
            'optimization_goal': 'LINK_CLICKS',
            'budget_type': params.budget_type,
            'budget': params.budget,
            'name_text': params.name_text,
            'end_time': params.end_time,
            'targeting': params.audience.data
        }, token);
    }).then(function (adset) {
        params.adset = adset;

        return ds.set('Experiment', {
            'data': {
                'cat1': params.contentInfo.cats[0],
                'cat2': params.contentInfo.cats[1],
                'cat3': params.contentInfo.cats[2],
                'content_id': params.contentInfo.id,
                'created_at': new Date(),
                'adset': ds.jsonToKey(params.adset.key),
                'name_text': params.name_text,
                'end_time': new Date(params.end_time * 1000),
                'active': false,
                'click': 0
            }
        }, params.team_id);
    });
};
