var ds = require('@lib/resources/ds'),
    Promise = require('bluebird'),
    extend = require('extend'),
    editTest = require('@lib/model/experiment/test/edit');

function parseParams (p) {
    var params = {};

    params.team_id = p.team_id || 0;
    params.content_id = p.content_id;
    params.data = p.data || {};

    return params;
}

function updateActive (value, item, token) {
    return Promise.all((item.data.tests || []).map(function (test) {
        return editTest({
            'team_id': test.namespace,
            'id': test.name,
            'data': {
                'active': value
            }
        }, token);
    }));
}

function update (params, item, token) {
    if (typeof params.data.active !== 'undefined') {
        item.data.active = Boolean(params.data.active);
        return updateActive(item.data.active, item, token);
    }

    return item;
}

module.exports = function (params, token) {
    params = parseParams(params);

    return ds.get(
        'Experiment',
        params.content_id,
        params.team_id
    ).then(function (item) {
        return update(params, item, token);
    }).then(function (item) {
        return ds.extend('Experiment', params.content_id, function (data) {
            return extend({}, data, item.data);
        }, params.team_id);
    }).then(function () {
        return 'successful';
    });
};
