var path = require('path'),
    db = require('@lib/resources/db'),
    Promise = require('bluebird'),
    sqlUtils = require('@lib/utils/sql'),
    dynamo = require('@lib/resources/dynamodb'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    admin = {};

admin.getInactive = function (teamId, pool) {
    return dynamo.init().then(function (dynamodb) {
        var promises = {};

        promises.name = db.q(q['get_team'], {
            'team_id': teamId
        }, pool);
        promises.status = dynamo.getItem(
            'team',
            String(teamId),
            '1',
            dynamodb
        );

        return Promise.props(promises);
    }).then(function (resp) {
        var status = 1;

        if (!resp.status ||
            !Object.keys(resp.status).length ||
            !Number(resp.status.tracking)
        ) {
            status = 0;
        }

        return {
            'status': status,
            'name': resp.name[0] && resp.name[0].name || ''
        };
    });
};

admin.setInactive = function (teamId, status) {
    var dynamodb;

    return dynamo.init().then(function (resp) {
        dynamodb = resp;

        return dynamo.getItem(
            'team',
            String(teamId),
            '1',
            dynamodb
        );
    }).then(function (item) {
        item = item || {};
        item.id = String(teamId);
        item.range = '1';
        item.tracking = Number(status);

        return dynamo.putItem('team', item, dynamodb);
    }).then(function () {
        return 'success';
    });
};

admin.getPayment = function (teamId, pool) {
    return db.q(q['get_team'], {
        'team_id': teamId
    }, pool).then(function (rows) {
        var amount = rows[0] && Number(rows[0].payment_amount) || 0,
            name = rows[0] && rows[0].name || '';

        return {
            'status': Boolean(amount),
            'name': name,
            'amount': amount
        };
    });
};

admin.setPayment = function (teamId, amount, pool) {
    return db.q(q['set_team'], {
        'team_id': teamId,
        'payment_amount': amount
    }, pool).then(function () {
        return 'success';
    });
};

module.exports = admin;
