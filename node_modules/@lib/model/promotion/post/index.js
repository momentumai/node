var path = require('path'),
    Promise = require('bluebird'),
    db = require('@lib/resources/db'),
    sqlUtils = require('@lib/utils/sql'),
    dynamo = require('@lib/resources/dynamodb'),
    Facebook = require('@lib/utils/facebook'),
    urlUtils = require('@lib/utils/url'),
    cryptoUtils = require('@lib/utils/crypto'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    post = {};

function getContent (teamId, contentId) {
    return dynamo.init().then(function (dynamodb) {
        return dynamo.getItem(
            'content',
            [teamId, contentId].join('-'),
            '1',
            dynamodb
        );
    }).then(function (result) {
        if (!result || !result.url) {
            throw 'Couldn\'t find content.';
        }

        if (result.title) {
            result.title = new Buffer(result.title, 'base64').toString('utf8');
        } else {
            result.title = result.url;
        }

        return result;
    });
}

post.ogdata = function (teamId, contentId) {
    return getContent(teamId, contentId).then(function (content) {
        return Facebook.getOgData(content.url);
    });
};

function addCampaign (
    teamId,
    cats,
    contentId,
    now,
    adaccount,
    fb,
    meta,
    endTime,
    pool
) {
    var token = cryptoUtils.randomString(8);

    return db.q(q['insert_campaign'], {
        'team_id': teamId,
        'cat1': cats[0] || 0,
        'cat2': cats[1] || 0,
        'cat3': cats[2] || 0,
        'content_id': contentId,
        'created_at': now,
        'adaccount': adaccount,
        'adset_id': '',
        'meta': JSON.stringify(meta),
        'token': token,
        'end_time': endTime
    }, pool).then(function (resp) {
        return {
            'token': token,
            'id': resp.insertId
        };
    });
}

function createAdCreative (teamId, contentId, settings, campaign, content, fb) {
    var url = settings.page_id + '?fields=access_token',
        local = {},
        post,
        utm = {
            'utm_source': settings.utm_source || '',
            'utm_medium': settings.utm_medium || '',
            'utm_campaign': settings.utm_campaign || ''
        },
        link;

    link = urlUtils.addCampaignParams(content.url, campaign.id, campaign.token);
    link = urlUtils.addUTM(link, utm);

    post = {
        'link': link,
        'message': settings.message,
        'name': settings.name,
        'description': settings.description,
        'caption': settings.caption,
        'published': false
    };

    if (settings.image) {
        post.picture = settings.image;
    }

    return getContent(teamId, contentId).then(function (content) {
        local.content_name = [
            content.title.substr(0, 64),
            (content.title.length > 64) ? '...' : ''
        ].join('');

        return Facebook.get(url, fb.token);
    }).then(function (resp) {
        url = settings.page_id + '/feed';

        return Facebook.post(url, post, resp.access_token);
    }).then(function (resp) {
        var params = {
            'name': 'Momentum ' + local.content_name,
            'object_story_id': resp.id
        };

        url = settings.ad_account + '/adcreatives';

        return Facebook.post(url, params, fb.token);
    });
}

function getContentCats (teamId, contentId, pool) {
    return db.q(q['get_content_cats'], {
        'team_id': teamId,
        'content_id': contentId
    }, pool).then(function (resp) {
        var cats = [];

        if (!resp[0] || !resp[0].cat1) {
            return cats;
        }
        cats.push(Number(resp[0].cat1));

        if (!resp[0].cat2) {
            return cats;
        }
        cats.push(Number(resp[0].cat2));

        if (!resp[0].cat3) {
            return cats;
        }
        cats.push(Number(resp[0].cat3));

        return cats;
    });
}

post.preview = function (teamId, contentId, pool, settings, context) {
    var creativeId,
        content,
        campaign,
        fb = context.fb,
        now = context.now,
        cats;

    settings = settings || {};

    return getContent(teamId, contentId).then(function (resp) {
        content = resp;

        return getContentCats(teamId, contentId, pool);
    }).then(function (resp) {
        cats = resp;

        return addCampaign(
            teamId,
            cats,
            contentId,
            now,
            settings.ad_account,
            fb,
            settings.meta || {},
            settings.end_time || 0,
            pool
        );
    }).then(function (resp) {
        campaign = resp;

        return createAdCreative(
            teamId,
            contentId,
            settings,
            campaign,
            content,
            fb
        );
    }).then(function (resp) {
        var url = resp.id + '/previews?ad_format=DESKTOP_FEED_STANDARD&' +
            'width=520&' +
            'height=280';

        creativeId = resp.id;
        if (!settings.skip) {
            return Facebook.get(url, fb.token).catch(function () {
                return Promise.delay(5000).then(function () {
                    return Facebook.get(url, fb.token);
                });
            });
        }
    }).then(function (resp) {
        return {
            'creative_id': creativeId,
            'preview': (settings.skip) ? '' : resp.data[0].body,
            'campaign': campaign
        };
    });
};

module.exports = post;
