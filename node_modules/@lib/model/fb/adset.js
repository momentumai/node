var Facebook = require('@lib/utils/facebook'),
    ds = require('@lib/resources/ds'),
    adsetModel = {};

function parseParams (p) {
    var params = {};

    params.adaccount = p.adaccount || 'NONE';
    params.optimization_goal = p.optimization_goal || '';
    params.budget_type = p.budget_type || '';
    params.budget = Number(p.budget) || 0;
    params.name_text = p.name_text || '';
    params.targeting = p.targeting || {};
    params.budget_type = p.budget_type || 'budget_type';

    return params;
}

function createFbAdset (campaign, params, token) {
    var url = params.adaccount + '/adsets',
        fbParams = {
            'billing_event': params.optimization_goal,
            'campaign_id': campaign.data.fb_id,
            'is_autobid': true,
            'name': params.name_text,
            'optimization_goal': params.optimization_goal,
            'targeting': params.targeting
        };

    fbParams[params.budget_type] = params.budget;

    return Facebook.post(url, fbParams, token);
}

adsetModel.add = function (campaign, params, token) {
    params = parseParams(params);

    return createFbAdset(campaign, params, token).then(function (resp) {
        return ds.set('FacebookAdset', {
            'data': {
                'campaign': ds.jsonToKey(campaign.key),
                'fb_id': resp.id
            }
        }, campaign.key.namespace);
    });
};

module.exports = adsetModel;
