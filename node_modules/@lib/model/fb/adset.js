var Facebook = require('@lib/utils/facebook'),
    ds = require('@lib/resources/ds'),
    adsetModel = {};

function parseParams (p) {
    var params = {};

    params.adaccount = p.adaccount || 'NONE';
    params.optimization_goal = p.optimization_goal || '';
    params.budget_type = p.budget_type || '';
    params.budget = Number(p.budget) || 0;
    params.end_time = Number(p.end_time) || 0;
    params.name_text = p.name_text || '';
    params.targeting = p.targeting || {};

    return params;
}

function createFbAdset (campaign, params, token) {
    var url = params.adaccount + '/adsets',
        fbParams = {
            'billing_event': params.optimization_goal,
            'campaign_id': campaign.key.name,
            'is_autobid': true,
            'name': params.name_text,
            'optimization_goal': params.optimization_goal,
            'end_time': params.end_time,
            'targeting': params.targeting
        };

    fbParams[params.budget_type] = params.budget;

    return Facebook.post(url, fbParams, token);
}

adsetModel.add = function (campaign, params, token) {
    params = parseParams(params);

    return createFbAdset(campaign, params, token).then(function (resp) {
        return ds.set('FacebookAdset', {
            'key': resp.id,
            'data': {
                'campaign': ds.jsonToKey(campaign.key),
                'created_at': new Date()
            }
        }, campaign.key.namespace);
    });
};

adsetModel.getDetails = function (adset, token) {
    var url = [
        adset.name,
        '?fields=lifetime_budget,daily_budget,',
        'insights.date_preset(lifetime){total_actions,spend}'
    ].join('');

    return Facebook.get(url, token).then(function (resp) {
        var insights = resp && resp.insights && resp.insights.data || [{}];

        insights = insights[0];
        return {
            'total_actions': insights.total_actions,
            'spend': insights.spend,
            'budget': Number(resp.lifetime_budget) || Number(resp.daily_budget),
            'budget_type': Number(resp.lifetime_budget) ? 'lifetime' : 'daily'
        };
    });
};

module.exports = adsetModel;
