var Facebook = require('@lib/utils/facebook'),
    ds = require('@lib/resources/ds'),
    adModel = {};

function parseParams (p) {
    var params = {};

    params.name = p.name || '';
    params.adaccount = p.adaccount || '';

    return params;
}

function createFbAd (adset, adcreative, params, token) {
    var url = params.adaccount + '/ads',
        fbParams = {
            'name': params.name,
            'adset_id': adset.key.name,
            'creative': JSON.stringify({
                'creative_id': adcreative.key.name
            }),
            'status': 'ACTIVE'
        };

    return Facebook.post(url, fbParams, token);
}

adModel.add = function (adset, adcreative, params, token) {
    params = parseParams(params);

    return createFbAd(adset, adcreative, params, token).then(function (resp) {
        return ds.set('FacebookAd', {
            'key': resp.id,
            'data': {
                'adset': ds.jsonToKey(adset.key),
                'adcreative': ds.jsonToKey(adcreative.key),
                'created_at': new Date()
            }
        }, adset.key.namespace);
    });
};

function parseUpdateParams (p) {
    var params = {};

    if (typeof p.name_text !== 'undefined') {
        params.name = p.name_text;
    }

    return params;
}

adModel.update = function (adset, params, token) {
    var fbParams = parseUpdateParams(params);

    return Facebook.post(adset.name, fbParams, token);
};

module.exports = adModel;
