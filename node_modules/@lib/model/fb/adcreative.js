var Facebook = require('@lib/utils/facebook'),
    ds = require('@lib/resources/ds'),
    adcreativeModel = {};

function parseParams (p) {
    var params = {};

    params.team_id = p.team_id || 0;
    params.adaccount = p.adaccount || '';
    params.page = p.page || '';

    params.link = p.link || '';
    params.message = p.message || '';
    params.name = p.name || '';
    params.description = p.description || '';
    params.caption = p.caption || '';
    params.name_text = p.name_text || '';
    params.image = p.image;

    return params;
}
function createFbAdcreative (params, token) {
    var url = params.page + '?fields=access_token',
        post;

    post = {
        'link': params.link,
        'message': params.message,
        'name': params.name,
        'description': params.description,
        'caption': params.caption,
        'published': false
    };

    if (params.image) {
        post.picture = params.image;
    }

    return Facebook.get(url, token).then(function (resp) {
        url = params.page + '/feed';
        return Facebook.post(url, post, resp.access_token);
    }).then(function (resp) {
        var obj = {
            'name': params.name_text,
            'object_story_id': resp.id
        };

        url = params.adaccount + '/adcreatives';

        return Facebook.post(url, obj, token);
    });
}

adcreativeModel.add = function (params, token) {
    params = parseParams(params);

    return createFbAdcreative(params, token).then(function (resp) {
        return ds.set('FacebookAdcreative', {
            'key': resp.id,
            'data': {
                'created_at': new Date()
            }
        }, params.team_id);
    });
};

module.exports = adcreativeModel;
