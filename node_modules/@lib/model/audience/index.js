var ds = require('@lib/resources/datastore'),
    uuid = require('@lib/utils/uuid'),
    audience = {};

audience.list = function (teamId) {
    return ds.init(teamId).then(function (datastore) {
        var query = datastore.createQuery('Audience');

        return ds.runQuery(query, datastore);
    }).then(function (queryResult) {
        var result = [];

        queryResult = queryResult || [];

        queryResult.forEach(function (item) {
            result.push({
                'id': item.key.name,
                'name': item.data.name,
                'data': JSON.parse(item.data.data)
            });
        });

        return result;
    });
};

audience.get = function (teamId, id) {
    return ds.get(teamId, 'Audience', id).then(function (item) {
        return {
            'id': id,
            'name': item.name,
            'data': JSON.parse(item.data)
        };
    });
};

audience.save = function (teamId, id, name, data) {
    var item = {
        'name': name,
        'data': JSON.stringify(data)
    };

    id = id || uuid.next();

    return ds.set(teamId, 'Audience', id, item).then(function () {
        return 'Success';
    });
};

module.exports = audience;
