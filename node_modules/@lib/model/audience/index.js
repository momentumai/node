var ds = require('@lib/resources/ds'),
    uuid = require('@lib/utils/uuid'),
    audience = {};

audience.list = function (teamId, adAccount) {
    return ds.query('Audience', function (query) {
        return query;
    }, teamId).then(function (queryResult) {
        var result = [];

        queryResult = queryResult || [];

        queryResult.forEach(function (item) {
            if (!adAccount || adAccount === item.data.ad_account) {
                result.push({
                    'id': item.key.name,
                    'ad_account': item.data.ad_account,
                    'name': item.data.name,
                    'data': JSON.parse(item.data.data || '{}'),
                    'meta': JSON.parse(item.data.meta || '{}')
                });
            }
        });

        return result;
    });
};

audience.listObject = function (teamId, adAccount) {
    return audience.list(teamId, adAccount).then(function (items) {
        var result = {};

        items.forEach(function (item) {
            result[item.id] = item.name;
        });

        return result;
    });
};

audience.get = function (teamId, id) {
    return ds.get('Audience', id, teamId).then(function (item) {
        return {
            'id': id,
            'ad_account': item.ad_account,
            'name': item.name,
            'data': JSON.parse(item.data || '{}'),
            'meta': JSON.parse(item.meta || '{}')
        };
    });
};

audience.save = function (session, id, adAccount, name, data, meta) {
    var item = {
        'ad_account': adAccount,
        'name': name,
        'data': JSON.stringify(data),
        'meta': JSON.stringify(meta)
    };

    id = id || uuid.next();

    if (!session.is_admin && !session.is_super) {
        throw 'model/auth:403:Unauthorized access';
    }

    return ds.set('Audience', {
        'key': id,
        'data': item
    }, session.team_id).then(function () {
        return 'Success';
    });
};

module.exports = audience;
