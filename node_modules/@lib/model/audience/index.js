var ds = require('@lib/resources/datastore'),
    uuid = require('@lib/utils/uuid'),
    audience = {};

audience.list = function (teamId, adAccount) {
    return ds.init(teamId).then(function (datastore) {
        var query = datastore.createQuery('Audience');

        return ds.runQuery(query, datastore);
    }).then(function (queryResult) {
        var result = [];

        queryResult = queryResult || [];

        queryResult.forEach(function (item) {
            if (!adAccount || adAccount === item.data.ad_account) {
                result.push({
                    'id': item.key.name,
                    'ad_account': item.data.ad_account,
                    'name': item.data.name,
                    'data': JSON.parse(item.data.data || {}),
                    'meta': JSON.parse(item.data.meta || {})
                });
            }
        });

        return result;
    });
};

audience.listObject = function (teamId, adAccount) {
    return audience.list(teamId, adAccount).then(function (items) {
        var result = {};

        items.forEach(function (item) {
            result[item.id] = item.name;
        });

        return result;
    });
};

audience.get = function (teamId, id) {
    return ds.get(teamId, 'Audience', id).then(function (item) {
        return {
            'id': id,
            'ad_account': item.ad_account,
            'name': item.name,
            'data': JSON.parse(item.data || {}),
            'meta': JSON.parse(item.meta || {})
        };
    });
};

audience.save = function (teamId, id, ad_account, name, data, meta) {
    var item = {
        'ad_account': ad_account,
        'name': name,
        'data': JSON.stringify(data),
        'meta': JSON.stringify(meta)
    };

    id = id || uuid.next();

    return ds.set(teamId, 'Audience', id, item).then(function () {
        return 'Success';
    });
};

module.exports = audience;
