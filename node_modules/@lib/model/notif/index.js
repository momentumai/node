var path = require('path'),
    gcm = require('node-gcm'),
    Promise = require('bluebird'),
    config = require('@config'),
    infoModel = require('@lib/model/content/info'),
    ds = require('@lib/resources/datastore'),
    catsUtils = require('@lib/utils/category'),
    sqlUtils = require('@lib/utils/sql'),
    db = require('@lib/resources/db'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    notif = {};

function getRegistrationId (endpoint) {
    return endpoint.replace('https://android.googleapis.com/gcm/send/', '');
}

notif.add = function (userId, endpoint) {
    var registrationId = getRegistrationId(endpoint);

    return ds.get(null, 'User', String(userId)).then(function (user) {
        user = user || {};
        user['registration_ids'] = user['registration_ids'] || [];

        if (user['registration_ids'].indexOf(registrationId) !== -1) {
            return;
        }
        user['registration_ids'].push(registrationId);

        return ds.set(null, 'User', String(userId), user, ['registration_ids']);
    }).then(function () {
        return 1;
    });
};

notif.remove = function (userId, registrationId) {
    return ds.get(null, 'User', String(userId)).then(function (user) {
        user = user || {};
        user['registration_ids'] = user['registration_ids'] || [];

        user['registration_ids'] = user['registration_ids']
            .filter(function (id) {
                return id !== registrationId;
            });

        return ds.set(null, 'User', String(userId), user, ['registration_ids']);
    }).then(function () {
        return 1;
    });
};

notif.get = function (userId) {
    return ds.get(null, 'User', String(userId)).then(function (user) {
        user = user || {};
        user['registration_ids'] = user['registration_ids'] || [];

        return user['registration_ids'].sort()
        .filter(function (item, pos, ary) {
            return !pos || item !== ary[pos - 1];
        });
    });
};

notif.send = function (registrationTokens, params, data) {
    return new Promise(function (resolve, reject) {
        var message = new gcm.Message({
                'collapseKey': data.id,
                'priority': 'normal',
                'contentAvailable': true,
                'timeToLive': 1,
                'dryRun': config.gcm.dryRun,
                'data': data,
                'notification': {
                    'title': params.title,
                    'icon': 'images/icon64.png',
                    'body': params.body
                }
            }),
            sender = new gcm.Sender(config.gcm.apiKey);

        sender.send(message, {
            'registrationTokens': registrationTokens
        }, 5, function (err, response) {
            if (err) {
                console.error('GCM Error:', err);
                return reject(err);
            }
            console.log('GCM Success:', response);
            return resolve(response);
        });
    });
};

notif.sendForTeam = function (params, pool) {
    var cats = [],
        ids = [];

    cats.push(params.cat1 || 'NONE');
    cats.push(params.cat2 || 'NONE');
    cats.push(params.cat3 || 'NONE');
    params.team_id = parseInt(params.team_id);

    return db.q(q['get_users'], params, pool).then(function (rows) {
        var promises = rows.map(function (item) {
            item.cats = JSON.parse(item.cats || '[]') || [];
            catsUtils.extend(item.cats);
            return item;
        }).filter(function (item) {
            return catsUtils.compare(item.cats, cats);
        }).reduce(function (prev, act) {
            prev.push(notif.get(act.user_id));
            return prev;
        }, []);

        return Promise.all(promises);
    }).then(function (resp) {
        ids = [].concat.apply([], resp);

        if (ids.length) {
            return infoModel.get(params.team_id, params.content_id);
        }
    }).then(function (info) {
        var url = [
            config.frontend.docBase,
            '/#/dashboard/main/content/',
            params.content_id
        ].join('');

        if (ids.length) {
            return notif.send(ids, {
                'title': 'You should promote this content',
                'body': info.title
            }, {
                'id': params.content_id,
                'type': 'add',
                'url': url
            });
        }
    });
};

module.exports = notif;
