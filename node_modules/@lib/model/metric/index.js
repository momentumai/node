var path = require('path'),
    Promise = require('bluebird'),
    db = require('@lib/resources/db'),
    time = require('@lib/utils/time'),
    sqlUtils = require('@lib/utils/sql'),
    q = sqlUtils.getQueries(path.join(__dirname, 'sql')),
    metric = {};

metric.getInterval = function (teamId, now, cats, pool) {
    var params = {};

    params.to = time.toMinutes(5, 5, now);
    params.from = time.subtractOneDay(params.to);
    params.team_id = teamId;
    params.cats = cats;

    return db.q(q['get_shares'], params, pool).then(function (rows) {
        var shares = rows[0] && rows[0].share || 0,
            hours = !shares ? 24 : (
                Math.min(24, Math.ceil(Math.max(1, 360000 / shares)))
            );

        return Promise.resolve(hours * 3600);
    });
};

module.exports = metric;
